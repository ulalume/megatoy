name: CI

on:
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    container: ubuntu:20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          export TZ=UTC
          apt-get update
          apt-get install -y \
            build-essential \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libwayland-dev \
            libxkbcommon-dev \
            libgtk-3-dev \
            xorg-dev \
            libasound2-dev \
            libpulse-dev \
            cmake pkg-config git tzdata curl gnupg \
            libcurl4-openssl-dev
          curl -fsSL https://apt.kitware.com/keys/kitware-archive-latest.asc | gpg --dearmor -o /usr/share/keyrings/kitware-archive-keyring.gpg
          echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ focal main' > /etc/apt/sources.list.d/kitware.list
          apt-get update
          apt-get install -y cmake
      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=install

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Install artifacts
        run: cmake --install build --config Release

  build-macos-arm64:
    name: Build macOS (arm64)
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_INSTALL_PREFIX=install

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Install artifacts
        run: cmake --install build --config Release

  build-macos-x86_64:
    name: Build macOS (Intel)
    runs-on: macos-15-intel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_INSTALL_PREFIX=install

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Install artifacts
        run: cmake --install build --config Release

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git ${{ runner.temp }}\vcpkg
          ${{ runner.temp }}\vcpkg\bootstrap-vcpkg.bat
          ${{ runner.temp }}\vcpkg\vcpkg.exe install curl[core,ssl]:x64-windows-static

      - name: Configure
        shell: pwsh
        run: >
          cmake -S . -B build
          -DCMAKE_BUILD_TYPE=Release
          -G "Visual Studio 17 2022"
          -A x64
          -DCMAKE_INSTALL_PREFIX=install
          -DCMAKE_TOOLCHAIN_FILE="${{ runner.temp }}\vcpkg\scripts\buildsystems\vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET=x64-windows-static

      - name: Build
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Install artifacts
        shell: pwsh
        run: cmake --install build --config Release
  build-web:
    name: Build Web (WASM)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten SDK
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest

      - name: Configure
        run: emcmake cmake -S . -B build-web -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build-web --target megatoy --parallel

      - name: Upload web-dist
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: build-web/web_dist
