name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create or Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TITLE="megatoy ${GITHUB_REF_NAME}"
          if gh release view "$GITHUB_REF_NAME" >/dev/null 2>&1; then
            gh release edit "$GITHUB_REF_NAME" --title "$TITLE" --latest
          else
            gh release create "$GITHUB_REF_NAME" --title "$TITLE" --generate-notes --latest
          fi

  build:
    needs: create_release
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: Linux (x64)
            os: linux
            runner: ubuntu-latest
            suffix: linux-x64
            cmake_args: ""
          - label: macOS (arm64)
            os: macos
            runner: macos-14
            suffix: macos-arm64
            cmake_args: "-DCMAKE_OSX_ARCHITECTURES=arm64"
          - label: macOS (Intel)
            os: macos
            runner: macos-13
            suffix: macos-x86_64
            cmake_args: "-DCMAKE_OSX_ARCHITECTURES=x86_64"
          - label: Windows (x64)
            os: windows
            runner: windows-latest
            suffix: windows-x64
            cmake_args: ""

    env:
      BUILD_TYPE: Release
      VERSION: ${{ github.ref_name }}
      PACKAGE_NAME: megatoy-${{ github.ref_name }}-${{ matrix.suffix }}
      INSTALL_PREFIX: ${{ github.workspace }}/build-release/install
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux only)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgl1-mesa-dev libglu1-mesa-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
            libgtk-3-dev xorg-dev

      - name: Configure CMake
        run: |
          cmake -S . -B build-release \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_INSTALL_PREFIX="$INSTALL_PREFIX" \
            ${{ matrix.cmake_args }}
        shell: bash

      - name: Build & Install
        run: |
          cmake --build build-release --config $BUILD_TYPE --parallel
          cmake --install build-release --config $BUILD_TYPE --prefix "$INSTALL_PREFIX"
        shell: bash

      - name: Package Artifact
        run: |
          set -euo pipefail
          mkdir -p dist
          DIST="dist/$PACKAGE_NAME"
          rm -rf "$DIST"

          if [[ "${{ matrix.os }}" == "linux" ]]; then
            STAGING="$INSTALL_PREFIX"
            mkdir -p "$DIST"
            cp -r "$STAGING"/{megatoy,bin/megatoy,presets,bin/presets} 2>/dev/null || true
            chmod +x "$DIST"/megatoy
            (cd dist && zip -r "$PACKAGE_NAME.zip" "$PACKAGE_NAME")

          elif [[ "${{ matrix.os }}" == "macos" ]]; then
            APP="build-release/megatoy.app"
            [ -d "$APP" ] || (echo "App bundle not found" && exit 1)
            ditto -c -k --keepParent "$APP" "dist/$PACKAGE_NAME.zip"

          else # windows
            pwsh -Command @'
            $ErrorActionPreference = "Stop"
            $install = "$env:INSTALL_PREFIX"
            $dist = "dist/$env:PACKAGE_NAME"
            Remove-Item $dist -Recurse -Force -ErrorAction Ignore
            New-Item -ItemType Directory -Path $dist | Out-Null
            Copy-Item "$install/megatoy.exe" $dist -Force
            if (Test-Path "$install/presets") { Copy-Item "$install/presets" $dist -Recurse -Force }
            Compress-Archive -Path $dist -DestinationPath "dist/$env:PACKAGE_NAME.zip" -Force
            '@
          fi

      - name: Upload Artifact
        run: gh release upload "$GITHUB_REF_NAME" "dist/$PACKAGE_NAME.zip" --clobber
        shell: bash
